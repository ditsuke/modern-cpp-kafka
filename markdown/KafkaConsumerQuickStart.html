
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>KafkaConsumer Quick Start</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
    <style>
      pre { background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 0.6em 1em; }
      h1,h2 { margin-top: 1em; }
      div.navbar { padding: 8px 0; }
      div.toc { float: right; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="kafkaconsumer-quick-start"><a class="toclink" href="#kafkaconsumer-quick-start">KafkaConsumer Quick Start</a></h1>
<p>Generally speaking, The <code>modern-cpp-kafka API</code> is quite similar with <a href="https://kafka.apache.org/22/javadoc/org/apache/kafka/clients/consumer/KafkaConsumer.html">Kafka Java's API</a></p>
<p>We'd recommend users to cross-reference them, --especially the examples.</p>
<h2 id="kafkaconsumer-with-enableautocommittrue"><a class="toclink" href="#kafkaconsumer-with-enableautocommittrue">KafkaConsumer (with <code>enable.auto.commit=true</code>)</a></h2>
<ul>
<li>
<p>Automatically commits previously polled offsets on each <code>poll</code> (and the final <code>close</code>) operations.</p>
<ul>
<li>Note, the internal <code>offset commit</code> is asynchronous, and is not guaranteed to succeed. It's supposed to be triggered (within each <code>poll</code> operation) periodically, thus the occasional failure doesn't quite matter.</li>
</ul>
</li>
</ul>
<h3 id="example"><a class="toclink" href="#example"><a href="https://github.com/morganstanley/modern-cpp-kafka/blob/main/examples/kafka_auto_commit_consumer.cc">Example</a></a></h3>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">kafka</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">kafka</span><span class="o">::</span><span class="nn">clients</span><span class="o">::</span><span class="nn">consumer</span><span class="p">;</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Create configuration object</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Properties</span><span class="w"> </span><span class="nf">props</span><span class="w"> </span><span class="p">({</span><span class="w"></span>

<span class="w">            </span><span class="p">{</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">brokers</span><span class="p">}},</span><span class="w"></span>

<span class="w">        </span><span class="p">});</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Create a consumer instance</span>

<span class="w">        </span><span class="n">KafkaConsumer</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="n">props</span><span class="p">);</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Subscribe to topics</span>

<span class="w">        </span><span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">({</span><span class="n">topic</span><span class="p">});</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Read messages from the topic</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;% Reading messages from topic: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">record</span><span class="o">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="c1">// In this example, quit on empty message</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>



<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">record</span><span class="p">.</span><span class="n">error</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;% Got a new message...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Topic    : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">topic</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Partition: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">partition</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Offset   : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">offset</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Timestamp: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">timestamp</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Headers  : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">toString</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">headers</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Key   [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">key</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Value [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>



<span class="w">        </span><span class="c1">// consumer.close(); // No explicit close is needed, RAII will take care of it</span>
</code></pre></div>

<ul>
<li>
<p><code>bootstrap.servers</code> property is mandatory for a Kafka client.</p>
</li>
<li>
<p><code>subscribe</code> could take a topic list. It's a block operation, would wait the consumer to get partitions assigned.</p>
</li>
<li>
<p><code>poll</code> must be called periodically, thus to trigger kinds of callback handling internally. In practice, it could be put in a "while loop".</p>
</li>
<li>
<p>At the end, we could <code>close</code> the consumer explicitly, or just leave it to the destructor.</p>
</li>
</ul>
<h2 id="kafkaconsumer-with-enableautocommitfalse"><a class="toclink" href="#kafkaconsumer-with-enableautocommitfalse">KafkaConsumer (with <code>enable.auto.commit=false</code>)</a></h2>
<ul>
<li>Users must commit the offsets for received records manually.</li>
</ul>
<h3 id="example_1"><a class="toclink" href="#example_1"><a href="https://github.com/morganstanley/modern-cpp-kafka/blob/main/examples/kafka_manual_commit_consumer.cc">Example</a></a></h3>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="c1">// Create configuration object</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">Properties</span><span class="w"> </span><span class="nf">props</span><span class="w"> </span><span class="p">({</span><span class="w"></span>

<span class="w">            </span><span class="p">{</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">{</span><span class="n">brokers</span><span class="p">}},</span><span class="w"></span>

<span class="w">            </span><span class="p">{</span><span class="s">&quot;enable.auto.commit&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="p">}}</span><span class="w"></span>

<span class="w">        </span><span class="p">});</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Create a consumer instance</span>

<span class="w">        </span><span class="n">KafkaConsumer</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="n">props</span><span class="p">);</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Subscribe to topics</span>

<span class="w">        </span><span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">({</span><span class="n">topic</span><span class="p">});</span><span class="w"></span>



<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">lastTimeCommitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Read messages from the topic</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;% Reading messages from topic: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">allCommitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">running</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">record</span><span class="o">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="c1">// In this example, quit on empty message</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>



<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">record</span><span class="p">.</span><span class="n">error</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;% Got a new message...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Topic    : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">topic</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Partition: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">partition</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Offset   : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">offset</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Timestamp: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">timestamp</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Headers  : &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">toString</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">headers</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Key   [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">key</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;    Value [&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>



<span class="w">                    </span><span class="n">allCommitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>



<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">allCommitted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastTimeCommitted</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// Commit offsets for messages polled</span>

<span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;% syncCommit offsets: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">utility</span><span class="o">::</span><span class="n">getCurrentTime</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">consumer</span><span class="p">.</span><span class="n">commitSync</span><span class="p">();</span><span class="w"> </span><span class="c1">// or commitAsync()</span>



<span class="w">                    </span><span class="n">lastTimeCommitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="n">allCommitted</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>



<span class="w">        </span><span class="c1">// consumer.close(); // No explicit close is needed, RAII will take care of it</span>
</code></pre></div>

<ul>
<li>
<p>The example is quite similar with the previous <code>enable.auto.commit=true</code> case, but has to call <code>commitSync</code>(or <code>commitAsync</code>) manually.</p>
</li>
<li>
<p><code>commitSync</code> and <code>commitAsync</code> are both available here. Normally, use <code>commitSync</code> to guarantee the commitment, or use <code>commitAsync</code>(with <code>OffsetCommitCallback</code>) to get a better performance.</p>
</li>
</ul>
<h2 id="about-enablemanualeventspoll"><a class="toclink" href="#about-enablemanualeventspoll">About <code>enable.manual.events.poll</code></a></h2>
<p>While we construct a <code>KafkaConsumer</code> with <code>enable.manual.events.poll=false</code> (i.e. the default option), an internal thread would be created for <code>OffsetCommit</code> callbacks handling.</p>
<p>This might not be what you want, since then you have to use 2 different threads to process the messages and handle the <code>OffsetCommit</code> responses.</p>
<p>Here we have another choice, -- using <code>enable.manual.events.poll=true</code>, thus the <code>OffsetCommit</code> callbacks would be called within member function <code>pollEvents()</code>.</p>
<h3 id="example_2"><a class="toclink" href="#example_2">Example</a></h3>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">KafkaConsumer</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="n">props</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;enable.manual.events.poll&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">));</span><span class="w"></span>



<span class="w">    </span><span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">({</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic2&quot;</span><span class="p">});</span><span class="w"></span>



<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">record</span><span class="o">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Process the message...</span>

<span class="w">            </span><span class="n">process</span><span class="p">(</span><span class="n">record</span><span class="p">);</span><span class="w"></span>



<span class="w">            </span><span class="c1">// Here we commit the offset manually</span>

<span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="n">commitSync</span><span class="p">(</span><span class="o">*</span><span class="n">record</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Here we call the `OffsetCommit` callbacks</span>

<span class="w">        </span><span class="c1">// Note, we can only do this while the consumer was constructed with `enable.manual.events.poll=true`.</span>

<span class="w">        </span><span class="n">consumer</span><span class="p">.</span><span class="n">pollEvents</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<h2 id="error-handling"><a class="toclink" href="#error-handling">Error handling</a></h2>
<p>Normally, exceptions might be thrown while operations fail, but not for a <code>poll</code> operation, -- if an error occurs, the <code>Error</code> would be embedded in the <code>Consumer::ConsumerRecord</code>.</p>
<p>About the <code>Error</code> <code>value()</code>, there are 2 cases</p>
<ul>
<li>
<p>Success</p>
<ul>
<li>
<p><code>RD_KAFKA_RESP_ERR__NO_ERROR</code> (<code>0</code>),  -- got a message successfully</p>
</li>
<li>
<p><code>RD_KAFKA_RESP_ERR__PARTITION_EOF</code>,   -- reached the end of a partition (no message got)</p>
</li>
</ul>
</li>
<li>
<p>Failure</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/A+Guide+To+The+Kafka+Protocol#AGuideToTheKafkaProtocol-ErrorCodes">Error Codes</a></li>
</ul>
</li>
</ul>
<h2 id="frequently-asked-questions"><a class="toclink" href="#frequently-asked-questions">Frequently Asked Questions</a></h2>
<ul>
<li>
<p>How to enhance the throughput</p>
<ul>
<li>
<p>Try with a larger <code>queued.min.messages</code>, especially for small messages.</p>
</li>
<li>
<p>Use multiple KafkaConsumers to distribute the payload.</p>
</li>
</ul>
</li>
<li>
<p>How to avoid polling duplicated messages</p>
<ul>
<li>
<p>To commit the offsets more frequently (e.g, always do commit after finishing processing a message).</p>
</li>
<li>
<p>Don't use quite a large <code>max.poll.records</code> for a <code>KafkaConsumer</code> (with <code>enable.auto.commit=true</code>) -- you might fail to commit all these messages before crash, thus more duplications with the next <code>poll</code>.</p>
</li>
</ul>
</li>
<li>
<p>How many threads would be created by a KafkaConsumer?</p>
<ul>
<li>
<p>Each broker (in the list of <code>bootstrap.servers</code>) would take a seperate thread to transmit messages towards a kafka cluster server.</p>
</li>
<li>
<p>Another 3 threads will handle internal operations, consumer group operations, and kinds of timers, etc.</p>
</li>
<li>
<p>By default, <code>enable.manual.events.poll=false</code>, then one more background thread would be created, which keeps polling/processing the offset-commit callback event.</p>
</li>
</ul>
</li>
<li>
<p>Which one of these threads will handle the callbacks?</p>
<ul>
<li>
<p><code>RebalanceCallback</code> will be triggered internally by the user's thread, -- within the <code>poll</code> function.</p>
</li>
<li>
<p>If <code>enable.auto.commit=true</code>, the <code>OffsetCommitCallback</code> will be triggered by the user's <code>poll</code> thread; otherwise, it would be triggered by a background thread (if <code>enable.manual.events.poll=true</code>), or by the <code>pollEvents()</code> call (if <code>enable.manual.events.poll=false</code>).</p>
</li>
</ul>
</li>
</ul>
      <hr/>
      <footer class="text-center text-muted">
        Generated: 2023. 01. 05
      </footer>
      <hr/>
    </div>
  </body>
</html>